<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº§å“ä¸Šå¸‚å…¨æ¡ˆé¡¹ç›®ç®¡ç† (Supabaseåä½œç‰ˆ)</title>
    
    <!-- å¼•å…¥ React å’Œ ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- å¼•å…¥ Babel ç”¨äºè§£æ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- å¼•å…¥ Lunar å†œå†åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.js"></script>

    <script>
        // ==========================================================================================
        // ğŸ”¥ğŸ”¥ğŸ”¥ Supabase é…ç½® ğŸ”¥ğŸ”¥ğŸ”¥
        // ==========================================================================================
        const supabaseUrl = "https://rbyvnkitojzfpkygrqkf.supabase.co"; 
        const supabaseKey = "sb_publishable_FtRFRTIPl8Ep6D7JW8GYcg_qFm4iobs";
        // ==========================================================================================

        let supabaseClient = null;
        
        try {
            const { createClient } = window.supabase;
            supabaseClient = createClient(supabaseUrl, supabaseKey);
            window.dbConfigured = true;
        } catch (e) {
            console.error("SDK åˆå§‹åŒ–å¤±è´¥", e);
            window.dbError = e.message;
        }
    </script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #6366f1; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .draggable-item { cursor: grab; }
        .draggable-item:active { cursor: grabbing; }
        .drag-over { border-color: #6366f1 !important; transform: scale(1.02); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .disabled-area { pointer-events: none; opacity: 0.7; }
        .lunar-text { font-family: "PingFang SC", "Microsoft YaHei", sans-serif; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. å›¾æ ‡ç»„ä»¶ (Icons) ---
        const IconBase = ({ children, ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>);
        const CalendarIcon = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const ChevronLeft = (props) => <IconBase {...props}><path d="m15 18-6-6 6-6"/></IconBase>;
        const ChevronRight = (props) => <IconBase {...props}><path d="m9 18 6-6-6-6"/></IconBase>;
        const Upload = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>;
        const CheckSquare = (props) => <IconBase {...props}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></IconBase>;
        const Square = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/></IconBase>;
        const LayoutGrid = (props) => <IconBase {...props}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></IconBase>;
        const Star = (props) => <IconBase {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const RefreshCcw = (props) => <IconBase {...props}><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></IconBase>;
        const ArrowLeft = (props) => <IconBase {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconBase>;
        const ArrowRight = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>;
        const Cloud = (props) => <IconBase {...props}><path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.5-2.3-2.5-4-4.9-4-2.8 0-5 2.2-5 5v2h14z"/></IconBase>;
        const CloudOff = (props) => <IconBase {...props}><path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 7h1.8a3 3 0 0 0 0 6h9.5"/><line x1="2" y1="2" x2="22" y2="22"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></IconBase>;
        const Settings = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const GripVertical = (props) => <IconBase {...props}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></IconBase>;
        const Plus = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const History = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></IconBase>;
        const Lock = (props) => <IconBase {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>;
        const Unlock = (props) => <IconBase {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></IconBase>;
        const Users = (props) => <IconBase {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>;
        const ListIcon = (props) => <IconBase {...props}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></IconBase>;
        const PlusCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></IconBase>;

        // --- 2. å¸¸é‡é…ç½® (Constants) ---
        const DEFAULT_MARKETING_NODES = {
            '01-01': 'å…ƒæ—¦', '02-14': 'æƒ…äººèŠ‚', '03-08': 'å¦‡å¥³èŠ‚', '03-12': 'æ¤æ ‘èŠ‚',
            '04-01': 'æ„šäººèŠ‚', '05-01': 'åŠ³åŠ¨èŠ‚', '05-04': 'é’å¹´èŠ‚', '05-20': '520å¤§ä¿ƒ',
            '06-01': 'å„¿ç«¥èŠ‚', '06-18': '618å¤§ä¿ƒ', '07-01': 'å»ºå…šèŠ‚', '08-01': 'å»ºå†›èŠ‚',
            '09-10': 'æ•™å¸ˆèŠ‚', '10-01': 'å›½åº†èŠ‚', '10-24': 'ç¨‹åºå‘˜èŠ‚', '10-31': 'ä¸‡åœ£èŠ‚',
            '11-11': 'åŒ11å¤§ä¿ƒ', '11-27': 'é»‘è‰²æ˜ŸæœŸäº”', '12-12': 'åŒ12å¤§ä¿ƒ',
            '12-24': 'å¹³å®‰å¤œ', '12-25': 'åœ£è¯èŠ‚'
        };

        const LAUNCH_TEMPLATE = {
            '-7': ['KOLç§è‰'], '-3': ['å€’è®¡æ—¶æµ·æŠ¥'], '0': ['å–ç‚¹æµ·æŠ¥'], '1': ['å–ç‚¹æµ·æŠ¥'],
            '2': ['å–ç‚¹æµ·æŠ¥'], '3': ['å–ç‚¹æµ·æŠ¥'], '7': ['äº§å“è§†é¢‘'], '14': ['åˆ›æ„è§†é¢‘'],
            '18': ['KOLäºŒåˆ›'], '24': ['å¥½è¯„æµ·æŠ¥']
        };

        const DEFAULT_OGC_ITEMS = {
            sellingPointPoster: { label: 'å–ç‚¹æµ·æŠ¥', done: false, remark: '' },
            creativePoster: { label: 'åˆ›æ„æµ·æŠ¥', done: false, remark: '' },
            productVideo: { label: 'äº§å“è§†é¢‘', done: false, remark: '' },
            creativeVideo: { label: 'åˆ›æ„è§†é¢‘', done: false, remark: '' },
            onePicture: { label: 'ä¸€å›¾çœ‹æ‡‚', done: false, remark: '' } // æ–°å¢
        };

        const OGC_KEY_MAP = {
            'sellingPointPoster': 'å–ç‚¹æµ·æŠ¥',
            'creativePoster': 'åˆ›æ„æµ·æŠ¥',
            'productVideo': 'äº§å“è§†é¢‘',
            'creativeVideo': 'åˆ›æ„è§†é¢‘',
            'onePicture': 'ä¸€å›¾çœ‹æ‡‚',
            'detailPage': 'äº§å“è¯¦æƒ…é¡µ'
        };

        const MATERIAL_OPTIONS = ['å–ç‚¹æµ·æŠ¥', 'åˆ›æ„æµ·æŠ¥', 'äº§å“è§†é¢‘', 'åˆ›æ„è§†é¢‘', 'KOLç§è‰', 'KOLäºŒåˆ›', 'PRç¨¿ä»¶', 'å€’è®¡æ—¶æµ·æŠ¥', 'å¥½è¯„æµ·æŠ¥', 'ä¸€å›¾çœ‹æ‡‚'];
        const WEEK_NAMES = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        const ADMIN_PASSWORD = "258992";
        
        const PRODUCT_COLORS = [
            { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-200', dot: 'bg-blue-500' },
            { bg: 'bg-emerald-100', text: 'text-emerald-800', border: 'border-emerald-200', dot: 'bg-emerald-500' },
            { bg: 'bg-purple-100', text: 'text-purple-800', border: 'border-purple-200', dot: 'bg-purple-500' },
            { bg: 'bg-amber-100', text: 'text-amber-800', border: 'border-amber-200', dot: 'bg-amber-500' },
            { bg: 'bg-rose-100', text: 'text-rose-800', border: 'border-rose-200', dot: 'bg-rose-500' },
            { bg: 'bg-cyan-100', text: 'text-cyan-800', border: 'border-cyan-200', dot: 'bg-cyan-500' },
        ];

        const getProductColor = (id) => PRODUCT_COLORS[id % PRODUCT_COLORS.length] || PRODUCT_COLORS[0];

        // --- 3. å·¥å…·å‡½æ•° ---
        const formatDate = (date) => {
            if (!date) return '';
            const d = new Date(date);
            if (isNaN(d.getTime())) return '';
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const addDays = (dateStr, days) => {
            const date = new Date(dateStr);
            date.setDate(date.getDate() + days);
            return formatDate(date);
        };

        const getDateInfo = (dateStr, customNodes = {}) => {
            if(!dateStr) return { label: null, isHighlight: false };
            const parts = dateStr.split('-');
            if(parts.length !== 3) return { label: null, isHighlight: false };
            
            if (customNodes[dateStr]) return { label: customNodes[dateStr], isHighlight: true, type: 'custom' };
            const key = `${parts[1]}-${parts[2]}`;
            if (DEFAULT_MARKETING_NODES[key]) return { label: DEFAULT_MARKETING_NODES[key], isHighlight: true, type: 'public' };

            try {
                const date = new Date(dateStr);
                const lunar = Lunar.fromDate(date);
                const festivals = lunar.getFestivals();
                if (festivals.length > 0) return { label: festivals[0], isHighlight: true, type: 'lunar_festival' };
                const jieQi = lunar.getJieQi();
                if (jieQi) return { label: jieQi, isHighlight: true, type: 'jieqi' };
                const dayName = lunar.getDayInChinese();
                const monthName = lunar.getMonthInChinese() + 'æœˆ';
                return { label: dayName === 'åˆä¸€' ? monthName : dayName, isHighlight: false, type: 'lunar_normal' };
            } catch(e) {
                return { label: null, isHighlight: false };
            }
        };

        const getMarketingNode = (dateStr, customNodes = {}) => {
            const info = getDateInfo(dateStr, customNodes);
            return info.isHighlight ? info.label : null;
        };

        const generateLaunchCycleDates = (launchDate) => {
            if (!launchDate) return [];
            const dates = [];
            for (let i = -7; i < 0; i++) dates.push({ date: addDays(launchDate, i), type: 'pre', dayOffset: i });
            dates.push({ date: launchDate, type: 'launch', dayOffset: 0 });
            for (let i = 1; i <= 35; i++) dates.push({ date: addDays(launchDate, i), type: 'post', dayOffset: i });
            return dates;
        };

        const generateDefaultEvents = (launchDate, customNodes = {}) => {
            const events = {};
            const launchDateObj = new Date(launchDate);
            const sortedOffsets = Object.keys(LAUNCH_TEMPLATE).map(Number).sort((a, b) => a - b);
            let accumulatedDelay = 0;

            sortedOffsets.forEach(offset => {
                const items = LAUNCH_TEMPLATE[offset];
                const isException = items.some(item => item.includes('å€’è®¡æ—¶'));
                let targetDate = new Date(launchDateObj);
                
                if (offset < 0) {
                    targetDate.setDate(targetDate.getDate() + offset);
                    if (!isException) {
                        const day = targetDate.getDay();
                        if (day === 0) targetDate.setDate(targetDate.getDate() - 2); 
                        if (day === 6) targetDate.setDate(targetDate.getDate() - 1); 
                    }
                } else {
                    targetDate.setDate(targetDate.getDate() + offset + accumulatedDelay);
                    if (!isException) {
                        const day = targetDate.getDay();
                        if (day === 6) { accumulatedDelay += 2; targetDate.setDate(targetDate.getDate() + 2); } 
                        else if (day === 0) { accumulatedDelay += 1; targetDate.setDate(targetDate.getDate() + 1); }
                    }
                }
                const dateStr = formatDate(targetDate);
                if (!events[dateStr]) events[dateStr] = [];
                items.forEach(content => {
                    if(!events[dateStr].some(e => e.content === content)) events[dateStr].push({ type: 'tag', content });
                });
            });

            const cycleDates = generateLaunchCycleDates(launchDate); 
            cycleDates.forEach(dayObj => {
                const dateStr = dayObj.date;
                const nodeName = getMarketingNode(dateStr, customNodes);
                if (nodeName) {
                    if (!events[dateStr]) events[dateStr] = [];
                    if (!events[dateStr].some(e => e.content === 'åˆ›æ„æµ·æŠ¥')) events[dateStr].push({ type: 'tag', content: 'åˆ›æ„æµ·æŠ¥' });
                }
            });
            return events;
        };

        const getDayLabel = (offset) => {
            if (offset === 0) return 'ä¸Šå¸‚æ—¥';
            if (offset < 0) return `T${offset}`;
            return `T+${offset}`;
        };

        // --- 4. å­ç»„ä»¶å®šä¹‰ (å¿…é¡»åœ¨ App ä¹‹å‰) ---

        const HomePage = ({ products, setProducts, fullProductList, navigateToProduct, updateProduct, updateProductDeep, softDeleteProduct, customNodes, canEdit, currentUser }) => {
            const fileInputRefs = useRef({});
            const dragItem = useRef();
            const dragOverItem = useRef();
            const [historyModalProduct, setHistoryModalProduct] = useState(null);
            const [homeViewMode, setHomeViewMode] = useState('grid'); 

            const handleDragStart = (e, position) => { if(!canEdit) return; dragItem.current = position; e.target.classList.add('opacity-50'); };
            const handleDragEnter = (e, position) => { if(!canEdit) return; dragOverItem.current = position; };
            const handleDragEnd = (e) => {
                if(!canEdit) return;
                e.target.classList.remove('opacity-50');
                if (dragItem.current === undefined || dragOverItem.current === undefined || dragItem.current === dragOverItem.current) { dragItem.current = null; dragOverItem.current = null; return; }
                const listCopy = [...fullProductList];
                const dragId = products[dragItem.current].id;
                const dropId = products[dragOverItem.current].id;
                const dragIndexFull = listCopy.findIndex(p => p.id === dragId);
                const dropIndexFull = listCopy.findIndex(p => p.id === dropId);
                const dragItemContent = listCopy[dragIndexFull];
                listCopy.splice(dragIndexFull, 1);
                listCopy.splice(dropIndexFull, 0, dragItemContent);
                setProducts(listCopy, 'é‡æ’äº§å“', 'åœ¨é¦–é¡µæ‹–æ‹½è°ƒæ•´äº†äº§å“é¡ºåº');
                dragItem.current = null;
                dragOverItem.current = null;
            };

            const handleImageUpload = (id, e) => {
                if(!canEdit) return;
                const file = e.target.files[0];
                if (file) {
                    if(file.size > 500 * 1024) { alert("å›¾ç‰‡éœ€å°äº500KB"); return; }
                    const reader = new FileReader();
                    reader.onloadend = () => updateProduct(id, 'image', reader.result);
                    reader.readAsDataURL(file);
                }
            };
            const addNewProduct = () => {
                const newId = fullProductList.length > 0 ? Math.max(...fullProductList.map(p => p.id)) + 1 : 1;
                const launchDate = formatDate(new Date());
                const defaultEvents = generateDefaultEvents(launchDate, customNodes);
                // é»˜è®¤ Basic åŒ…å« detailPage
                const newProduct = {
                    id: newId, name: "æ–°äº§å“ (å·²è‡ªåŠ¨è§„åˆ’)", level: "éé‡ç‚¹å“", deleted: false, launchDate: launchDate, image: null,
                    basics: { prototype: false, introFile: false, productImages: false, detailPage: false },
                    ogc: JSON.parse(JSON.stringify(DEFAULT_OGC_ITEMS)),
                    calendarEvents: defaultEvents,
                    backups: []
                };
                setProducts(prev => [...prev, newProduct], 'æ–°å¢äº§å“', 'åˆ›å»ºäº†æ–°äº§å“å¡ç‰‡');
            };

            const handleBackup = (e, productId) => {
                e.stopPropagation();
                setProducts(prev => prev.map(p => {
                    if (p.id !== productId) return p;
                    const snapshot = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        displayName: new Date().toLocaleString(),
                        user: currentUser || 'æœªçŸ¥',
                        data: { name: p.name, level: p.level, launchDate: p.launchDate, image: p.image, basics: p.basics, ogc: p.ogc, calendarEvents: p.calendarEvents }
                    };
                    const newBackups = [snapshot, ...(p.backups || [])].slice(0, 10); 
                    return { ...p, backups: newBackups };
                }), 'æ‰‹åŠ¨å¤‡ä»½', `å¤‡ä»½äº†äº§å“ID: ${productId}`);
                alert('å¤‡ä»½æˆåŠŸï¼');
            };

            const handleRestore = (productId, backupData) => {
                if(!confirm('ç¡®å®šè¦å›æ»šåˆ°æ­¤ç‰ˆæœ¬å—ï¼Ÿå½“å‰æœªå¤‡ä»½çš„å†…å®¹å°†ä¸¢å¤±ã€‚')) return;
                setProducts(prev => prev.map(p => {
                    if (p.id !== productId) return p;
                    return { ...p, ...backupData, backups: p.backups }; 
                }), 'ç‰ˆæœ¬å›æ»š', `å›æ»šäº§å“ID: ${productId} åˆ°å†å²ç‰ˆæœ¬`);
                setHistoryModalProduct(null);
            };

            return (
                <div>
                    <div className="flex justify-between items-end mb-6">
                        <div><h2 className="text-2xl font-bold text-slate-800">äº§å“çœ‹æ¿</h2><p className="text-slate-500 text-sm mt-1">{canEdit ? "æ”¯æŒæ‹–æ‹½æ’åº | é‡ç‚¹å“è‡ªåŠ¨ç½®é¡¶" : "å½“å‰ä¸ºåªè¯»æ¨¡å¼"}</p></div>
                        <div className="flex gap-2">
                            <div className="bg-white border rounded-md p-1 flex">
                                <button onClick={() => setHomeViewMode('grid')} className={`p-1.5 rounded ${homeViewMode === 'grid' ? 'bg-indigo-100 text-indigo-600' : 'text-slate-400 hover:bg-slate-50'}`}><LayoutGrid size={16} /></button>
                                <button onClick={() => setHomeViewMode('list')} className={`p-1.5 rounded ${homeViewMode === 'list' ? 'bg-indigo-100 text-indigo-600' : 'text-slate-400 hover:bg-slate-50'}`}><ListIcon size={16} /></button>
                            </div>
                            {canEdit && <button onClick={addNewProduct} className="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition shadow-sm font-medium">+ æ–°å¢äº§å“é¡¹ç›®</button>}
                        </div>
                    </div>

                    {homeViewMode === 'grid' ? (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {products.map((product, index) => {
                                const basicsTotal = product.basics ? Object.keys(product.basics).length : 0;
                                const basicsDone = product.basics ? Object.values(product.basics).filter(v => v).length : 0;
                                const basicsPercent = basicsTotal > 0 ? (basicsDone / basicsTotal) * 100 : 0;
                                
                                const ogcKeys = product.ogc ? Object.keys(product.ogc).filter(k => k !== 'detailPage') : [];
                                const ogcTotal = ogcKeys.length;
                                const ogcDone = ogcKeys.filter(k => product.ogc[k].done).length;
                                const ogcPercent = ogcTotal > 0 ? (ogcDone / ogcTotal) * 100 : 0;

                                return (
                                    <div key={product.id} className={`group bg-white rounded-xl shadow-sm border-2 transition-all hover:shadow-lg relative overflow-hidden flex flex-row h-64 draggable-item ${product.level === 'é‡ç‚¹å“' ? 'border-orange-200' : 'border-transparent'}`}
                                        draggable={canEdit} onDragStart={(e) => handleDragStart(e, index)} onDragEnter={(e) => handleDragEnter(e, index)} onDragEnd={handleDragEnd} onDragOver={(e) => e.preventDefault()}>
                                        
                                        {/* å·¦ä¾§æ­£æ–¹å½¢å›¾ç‰‡ - å›ºå®šå¤§å° h-64 w-64 */}
                                        <div className="w-64 h-full flex-shrink-0 relative bg-slate-100 flex items-center justify-center overflow-hidden border-r border-slate-100">
                                            {canEdit && <div className="absolute top-2 left-2 z-20 text-white/50 group-hover:text-white cursor-grab p-1 bg-black/20 rounded backdrop-blur-sm" title="é•¿æŒ‰æ‹–åŠ¨è°ƒæ•´é¡ºåº"><GripVertical size={16} /></div>}
                                            {product.level === 'é‡ç‚¹å“' && <div className="absolute top-0 right-0 bg-orange-100 text-orange-600 px-3 py-1 rounded-bl-lg text-xs font-bold z-10 flex items-center gap-1"><Star className="w-3 h-3 fill-current" /> é‡ç‚¹</div>}
                                            {product.image ? <img src={product.image} alt={product.name} className="w-full h-full object-cover pointer-events-none" /> : <div className="text-slate-400 flex flex-col items-center"><div className="w-12 h-12 bg-slate-200 rounded-full flex items-center justify-center mb-2"><span className="text-2xl font-bold text-slate-300">{product.name.charAt(0)}</span></div><span className="text-[10px]">ç‚¹å‡»ä¸Šä¼ </span></div>}
                                            <div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer" onClick={() => fileInputRefs.current[product.id]?.click()}><div className="text-white flex flex-col items-center"><Upload className="w-6 h-6 mb-1" /><span className="text-xs">æ›´æ¢å›¾ç‰‡</span></div><input type="file" ref={el => fileInputRefs.current[product.id] = el} className="hidden" accept="image/*" onChange={(e) => handleImageUpload(product.id, e)} /></div>
                                        </div>

                                        {/* å³ä¾§è¯¦æƒ…æ  */}
                                        <div className={`flex-1 p-4 flex flex-col justify-between ${!canEdit ? 'pointer-events-none' : ''}`}>
                                            <div>
                                                <div className="flex justify-between items-start mb-2">
                                                    <input type="text" value={product.name} onChange={(e) => updateProduct(product.id, 'name', e.target.value)} className="text-lg font-bold text-slate-800 border-b border-transparent hover:border-slate-300 focus:border-indigo-500 focus:outline-none bg-transparent w-full mr-2" />
                                                </div>
                                                
                                                <div className="grid grid-cols-2 gap-3 mb-2">
                                                    <div><label className="text-[10px] text-slate-400 block">ä¸Šå¸‚æ—¶é—´</label><input type="date" value={product.launchDate} onChange={(e) => updateProduct(product.id, 'launchDate', e.target.value)} className="text-xs font-medium text-slate-600 bg-transparent border-b border-transparent hover:border-slate-200 focus:border-indigo-500 outline-none w-full" /></div>
                                                    <div><label className="text-[10px] text-slate-400 block">ç­‰çº§</label><select value={product.level} onChange={(e) => updateProduct(product.id, 'level', e.target.value)} className={`text-xs font-medium bg-transparent border-none outline-none cursor-pointer ${product.level === 'é‡ç‚¹å“' ? 'text-orange-600' : 'text-slate-600'}`}><option value="é‡ç‚¹å“">é‡ç‚¹å“</option><option value="éé‡ç‚¹å“">éé‡ç‚¹å“</option></select></div>
                                                </div>

                                                <div className="flex gap-4 text-[10px] mb-2">
                                                    <div className="flex-1">
                                                        <div className="flex justify-between mb-0.5"><span className="text-slate-400">èµ„æ–™</span><span className={basicsPercent===100?'text-green-600':'text-amber-600'}>{basicsDone}/{basicsTotal}</span></div>
                                                        <div className="h-1 bg-slate-100 rounded-full overflow-hidden"><div className={`h-full ${basicsPercent===100?'bg-green-500':'bg-amber-400'}`} style={{width: `${basicsPercent}%`}}></div></div>
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className="flex justify-between mb-0.5"><span className="text-slate-400">ç‰©æ–™</span><span className={ogcPercent===100?'text-green-600':'text-blue-600'}>{ogcDone}/{ogcTotal}</span></div>
                                                        <div className="h-1 bg-slate-100 rounded-full overflow-hidden"><div className={`h-full ${ogcPercent===100?'bg-green-500':'bg-blue-400'}`} style={{width: `${ogcPercent}%`}}></div></div>
                                                    </div>
                                                </div>
                                                
                                                <input type="text" className="w-full text-xs text-slate-500 bg-slate-50 border border-transparent hover:border-slate-200 rounded px-2 py-1 outline-none truncate" placeholder="æ·»åŠ å¤‡æ³¨..." value={product.remark || ''} onChange={(e) => updateProduct(product.id, 'remark', e.target.value)} onClick={(e) => e.stopPropagation()} />
                                            </div>

                                            <div className="flex items-center justify-end gap-2 pt-2 border-t border-slate-50">
                                                {canEdit && <button onClick={(e) => handleBackup(e, product.id)} className="text-slate-400 hover:text-indigo-600 p-1" title="å¤‡ä»½"><Save size={14}/></button>}
                                                {canEdit && <button onClick={(e) => { e.stopPropagation(); setHistoryModalProduct(product); }} className="text-slate-400 hover:text-indigo-600 p-1" title="å†å²"><History size={14}/></button>}
                                                {canEdit && <button onClick={(e) => { e.stopPropagation(); e.preventDefault(); softDeleteProduct(product.id); }} className="text-slate-400 hover:text-red-500 p-1" title="åˆ é™¤"><Trash2 size={14}/></button>}
                                                <button onClick={(e) => { e.stopPropagation(); navigateToProduct(product.id); }} className={`ml-2 px-3 py-1 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 text-xs font-bold rounded flex items-center gap-1 transition-colors ${!canEdit ? 'pointer-events-auto' : ''}`}>è¯¦æƒ… <ArrowRight size={10} /></button>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    ) : (
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="grid grid-cols-[200px_100px_80px_120px_120px_200px_1fr_100px] bg-slate-50 border-b text-xs font-bold text-slate-500 p-3">
                                <div>äº§å“åç§°</div><div>ä¸Šå¸‚æ—¥æœŸ</div><div>ç­‰çº§</div><div>æ ·æœºæƒ…å†µ</div><div>ä»‹ç»æ–‡ä»¶</div><div>ç‰©æ–™æƒ…å†µ</div><div>å¤‡æ³¨</div><div className="text-right">æ“ä½œ</div>
                            </div>
                            <div className="divide-y divide-slate-100">
                                {products.map((product, index) => {
                                    // æ™ºèƒ½ä¿®å¤ä¸­æ–‡æ˜¾ç¤ºï¼šå¦‚æœæ—§æ•°æ®æ˜¯è‹±æ–‡keyï¼Œå°è¯•æ˜ å°„
                                    const doneMaterials = Object.entries(product.ogc || {})
                                        .filter(([key, val]) => val.done && key !== 'detailPage')
                                        .map(([key, val]) => val.label || OGC_KEY_MAP[key] || key); 
                                    const materialSummary = doneMaterials.length > 0 ? doneMaterials.join(', ') : 'æš‚æ— ';

                                    return (
                                        <div 
                                            key={product.id} 
                                            className={`grid grid-cols-[200px_100px_80px_120px_120px_200px_1fr_100px] items-center p-3 text-sm hover:bg-slate-50 transition-colors
                                                ${canEdit ? 'draggable-item' : ''} ${product.level === 'é‡ç‚¹å“' ? 'bg-orange-50/30' : ''}
                                            `}
                                            draggable={canEdit}
                                            onDragStart={(e) => handleDragStart(e, index)} 
                                            onDragEnter={(e) => handleDragEnter(e, index)} 
                                            onDragEnd={handleDragEnd} 
                                            onDragOver={(e) => e.preventDefault()}
                                        >
                                            <div className="font-bold text-slate-800 flex items-center gap-2 pr-4">
                                                {canEdit && <GripVertical size={14} className="text-slate-300 cursor-grab flex-shrink-0" />}
                                                <span className="truncate" title={product.name}>{product.name}</span>
                                                {product.level === 'é‡ç‚¹å“' && <Star size={12} className="text-orange-500 fill-current flex-shrink-0" />}
                                            </div>
                                            <div>
                                                <input type="date" value={product.launchDate} onChange={(e) => updateProduct(product.id, 'launchDate', e.target.value)} className="bg-transparent border-b border-transparent hover:border-slate-300 outline-none text-slate-600 w-full text-xs" disabled={!canEdit}/>
                                            </div>
                                            <div>
                                                <select value={product.level} onChange={(e) => updateProduct(product.id, 'level', e.target.value)} className="bg-transparent text-xs outline-none cursor-pointer" disabled={!canEdit}>
                                                    <option value="é‡ç‚¹å“">é‡ç‚¹å“</option>
                                                    <option value="éé‡ç‚¹å“">éé‡ç‚¹å“</option>
                                                </select>
                                            </div>
                                            <div className="flex gap-4">
                                                <button onClick={() => canEdit && updateProductDeep(products.findIndex(p=>p.id===product.id), ['basics', 'prototype'], !product.basics.prototype)} className={`flex items-center gap-1 text-xs ${product.basics.prototype ? 'text-green-600' : 'text-slate-400'}`}>
                                                    {product.basics.prototype ? <CheckSquare size={14}/> : <Square size={14}/>} æ ·æœº
                                                </button>
                                            </div>
                                            <div className="flex gap-4">
                                                <button onClick={() => canEdit && updateProductDeep(products.findIndex(p=>p.id===product.id), ['basics', 'introFile'], !product.basics.introFile)} className={`flex items-center gap-1 text-xs ${product.basics.introFile ? 'text-green-600' : 'text-slate-400'}`}>
                                                    {product.basics.introFile ? <CheckSquare size={14}/> : <Square size={14}/>} PPT
                                                </button>
                                            </div>
                                            <div className="text-xs text-slate-500 truncate pr-4" title={materialSummary}>
                                                {doneMaterials.length > 0 ? <span className="text-green-600">å·²å®Œæˆ: {materialSummary}</span> : <span className="text-slate-400">å¾…å¼€å§‹</span>}
                                            </div>
                                            <div className="pr-4">
                                                <input type="text" className="w-full bg-transparent border-b border-transparent hover:border-slate-300 outline-none text-xs text-slate-600" placeholder="å¤‡æ³¨..." value={product.remark || ''} onChange={(e) => updateProduct(product.id, 'remark', e.target.value)} disabled={!canEdit} />
                                            </div>
                                            <div className="flex justify-end gap-2">
                                                {canEdit && <button onClick={(e) => handleBackup(e, product.id)} className="text-slate-400 hover:text-indigo-600" title="å¤‡ä»½"><Save size={14}/></button>}
                                                {canEdit && <button onClick={(e) => { e.stopPropagation(); e.preventDefault(); softDeleteProduct(product.id); }} className="text-slate-400 hover:text-red-600" title="åˆ é™¤"><Trash2 size={14}/></button>}
                                                <button onClick={(e) => { e.stopPropagation(); navigateToProduct(product.id); }} className="text-indigo-600 hover:text-indigo-800 font-bold text-xs">è¯¦æƒ… &gt;</button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {historyModalProduct && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" onClick={() => setHistoryModalProduct(null)}>
                            <div className="bg-white rounded-xl shadow-2xl w-[500px] max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                                <div className="p-6 border-b flex justify-between items-center"><h3 className="text-xl font-bold flex items-center gap-2 text-slate-800"><History className="text-indigo-600"/> å†å²ç‰ˆæœ¬: {historyModalProduct.name}</h3><button onClick={() => setHistoryModalProduct(null)} className="text-slate-400 hover:text-slate-600"><X /></button></div>
                                <div className="p-6 overflow-y-auto flex-1">
                                    {(!historyModalProduct.backups || historyModalProduct.backups.length === 0) ? <div className="text-center py-10 text-slate-400">æš‚æ— å¤‡ä»½è®°å½•</div> : (
                                        <div className="space-y-3">
                                            {historyModalProduct.backups.map(backup => (
                                                <div key={backup.id} className="flex items-center justify-between p-4 bg-slate-50 rounded-lg border border-slate-100 hover:border-indigo-200 transition-colors">
                                                    <div><div className="font-bold text-slate-700">{backup.displayName} {backup.user && <span className="ml-2 text-xs font-normal text-slate-500 bg-slate-100 px-2 py-0.5 rounded">by {backup.user}</span>}</div><div className="text-xs text-slate-400 mt-1">å«æ’æœŸã€OGCç­‰å…¨éƒ¨æ•°æ®</div></div>
                                                    <button onClick={() => handleRestore(historyModalProduct.id, backup.data)} className="px-3 py-1.5 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 rounded text-sm font-medium transition-colors">å›æ»šè‡³æ­¤ç‰ˆæœ¬</button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ProductDetailPage = ({ product, updateProduct, updateProductDeep, customNodes, canEdit }) => {
            const fileInputRef = useRef(null);
            const timelineDates = generateLaunchCycleDates(product.launchDate);
            const [selectedDate, setSelectedDate] = useState(null);
            const [clickTimeout, setClickTimeout] = useState(null);
            const [modalType, setModalType] = useState(null);
            const [editText, setEditText] = useState('');

            const handleDayClick = (e, dateStr) => {
                if(!canEdit) return;
                if (clickTimeout) { clearTimeout(clickTimeout); setClickTimeout(null); handleDayDoubleClick(dateStr); } 
                else { const timeout = setTimeout(() => { setClickTimeout(null); openModal(e, dateStr, 'select'); }, 250); setClickTimeout(timeout); }
            };
            const handleDayDoubleClick = (dateStr) => { if(canEdit) openModal(null, dateStr, 'input'); };
            const openModal = (e, dateStr, type) => {
                setSelectedDate(dateStr); setModalType(type);
                if (type === 'input') { const existingText = product.calendarEvents[dateStr]?.find(ev => ev.type === 'text'); setEditText(existingText ? existingText.content : ''); }
            };
            const closeModal = () => { setModalType(null); setSelectedDate(null); setEditText(''); };
            const addEvent = (content, type) => {
                const currentEvents = product.calendarEvents[selectedDate] || [];
                let newEvents = [...currentEvents];
                if (type === 'text') {
                    const textIndex = newEvents.findIndex(e => e.type === 'text');
                    if (content.trim() === '') { if(textIndex > -1) newEvents.splice(textIndex, 1); } 
                    else { if(textIndex > -1) newEvents[textIndex].content = content; else newEvents.push({ type: 'text', content }); }
                } else { if (!newEvents.some(e => e.content === content && e.type === 'tag')) newEvents.push({ type: 'tag', content }); }
                updateProductDeep(product.id, ['calendarEvents', selectedDate], newEvents);
                closeModal();
            };
            const removeEvent = (e, dateStr, index) => {
                e.stopPropagation();
                const events = [...(product.calendarEvents[dateStr] || [])];
                events.splice(index, 1);
                updateProductDeep(product.id, ['calendarEvents', dateStr], events);
            };
            const clearSchedule = () => {
                if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ’æœŸè§„åˆ’å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼ˆé™¤éæœ‰å¤‡ä»½ï¼‰ã€‚')) updateProductDeep(product.id, ['calendarEvents'], {});
            };

            const addCustomOGCItem = () => {
                const name = prompt("è¯·è¾“å…¥æ–°ç‰©æ–™é¡¹åç§°ï¼š");
                if (name) {
                    const key = 'custom_' + Date.now();
                    updateProductDeep(product.id, ['ogc', key], { label: name, done: false, remark: '' });
                }
            }

            const deleteOGCItem = (key) => {
                if(confirm('ç¡®å®šåˆ é™¤æ­¤ç‰©æ–™é¡¹å—ï¼Ÿ')) {
                     const newOgc = { ...product.ogc };
                     delete newOgc[key];
                     updateProduct(product.id, 'ogc', newOgc);
                }
            }

            return (
                <div className="space-y-8 pb-20">
                    <section className={`bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col md:flex-row gap-8 ${!canEdit ? 'pointer-events-none' : ''}`}>
                        <div className="w-full md:w-64 h-64 bg-slate-100 rounded-lg flex-shrink-0 relative group overflow-hidden border border-slate-200">
                           {product.image ? <img src={product.image} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-slate-400">æš‚æ— å›¾ç‰‡</div>}
                           <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer" onClick={() => fileInputRef.current.click()}><span className="text-white font-medium flex items-center gap-2"><Upload size={16} /> æ›´æ¢å›¾ç‰‡</span></div>
                           <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={(e) => { const file = e.target.files[0]; if(file){ if(file.size>500*1024){alert('å›¾ç‰‡éœ€å°äº500KB');return;} const reader = new FileReader(); reader.onloadend = () => updateProduct(product.id, 'image', reader.result); reader.readAsDataURL(file); } }} />
                        </div>
                        <div className="flex-1 space-y-6">
                            <div><label className="text-sm text-slate-500">äº§å“åç§° (åŒå‡»ä¿®æ”¹)</label><input className="block w-full text-3xl font-bold text-slate-800 border-b-2 border-transparent hover:border-slate-200 focus:border-indigo-500 outline-none bg-transparent py-1" value={product.name} onChange={(e) => updateProduct(product.id, 'name', e.target.value)} /></div>
                            <div className="grid grid-cols-2 gap-8">
                                <div><label className="text-sm text-slate-500 mb-1 block">ä¸Šå¸‚æ—¶é—´</label><input type="date" className="block w-full text-lg font-medium text-slate-700 bg-slate-50 border border-slate-200 rounded px-3 py-2 outline-none" value={product.launchDate} onChange={(e) => updateProduct(product.id, 'launchDate', e.target.value)} /></div>
                                <div><label className="text-sm text-slate-500 mb-1 block">é¡¹ç›®çº§åˆ«</label><select className={`block w-full text-lg font-medium border rounded px-3 py-2 outline-none ${product.level === 'é‡ç‚¹å“' ? 'text-orange-600 bg-orange-50 border-orange-200' : 'text-slate-700 bg-slate-50 border-slate-200'}`} value={product.level} onChange={(e) => updateProduct(product.id, 'level', e.target.value)}><option value="é‡ç‚¹å“">é‡ç‚¹å“</option><option value="éé‡ç‚¹å“">éé‡ç‚¹å“</option></select></div>
                            </div>
                        </div>
                    </section>
                    <div className={`grid grid-cols-1 lg:grid-cols-2 gap-8 ${!canEdit ? 'pointer-events-none' : ''}`}>
                        <section className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><div className="w-1 h-5 bg-indigo-500 rounded-full"></div> åŸºæœ¬èµ„æ–™å‡†å¤‡</h3>
                            <div className="space-y-4">
                                {/* å°† detailPage æ·»åŠ åˆ°åŸºæœ¬èµ„æ–™ä¸­ */}
                                {[{ key: 'prototype', label: 'äº§å“æ ·æœº' }, { key: 'introFile', label: 'äº§å“ä»‹ç»æ–‡ä»¶' }, { key: 'productImages', label: 'äº§å“åŸºç¡€å›¾ç‰‡' }, { key: 'detailPage', label: 'äº§å“è¯¦æƒ…é¡µ' }].map(item => (
                                    <div key={item.key} className="flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg transition-colors border border-transparent hover:border-slate-100">
                                        <span className="text-slate-700">{item.label}</span>
                                        <button onClick={() => updateProductDeep(product.id, ['basics', item.key], !product.basics[item.key])} className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${product.basics[item.key] ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'}`}>{product.basics[item.key] ? <CheckSquare size={16} /> : <Square size={16} />}{product.basics[item.key] ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}</button>
                                    </div>
                                ))}
                            </div>
                        </section>
                        <section className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2"><div className="w-1 h-5 bg-pink-500 rounded-full"></div> OGC ç‰©æ–™è¿›åº¦</h3>
                                {canEdit && <button onClick={addCustomOGCItem} className="text-indigo-600 hover:bg-indigo-50 p-1 rounded transition"><PlusCircle size={20}/></button>}
                            </div>
                            <div className="space-y-3">
                                {/* è¿‡æ»¤æ‰ detailPageï¼Œåªæ˜¾ç¤ºå…¶ä»– OGC é¡¹ç›® */}
                                {Object.entries(product.ogc || {}).filter(([key]) => key !== 'detailPage').map(([key, item]) => (
                                    <div key={key} className="flex items-center gap-3 p-2 hover:bg-slate-50 rounded border border-transparent hover:border-slate-100 group">
                                        <div className="cursor-pointer text-slate-400 hover:text-indigo-600" onClick={() => updateProductDeep(product.id, ['ogc', key, 'done'], !item.done)}>{item.done ? <CheckSquare className="text-green-500" /> : <Square />}</div>
                                        <div className="w-24 text-slate-700 font-medium truncate" title={item.label || OGC_KEY_MAP[key] || key}>{item.label || OGC_KEY_MAP[key] || key}</div>
                                        <input type="text" placeholder="å¤‡æ³¨/æ•°é‡..." className="flex-1 bg-transparent border-b border-slate-200 focus:border-indigo-500 outline-none text-sm py-1 text-slate-600" value={item.remark} onChange={(e) => updateProductDeep(product.id, ['ogc', key, 'remark'], e.target.value)} />
                                        {canEdit && key.startsWith('custom_') && (
                                            <button onClick={() => deleteOGCItem(key)} className="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition"><X size={14}/></button>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </section>
                    </div>

                    {/* Schedule Section unchanged */}
                    <section className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <div className="flex justify-between items-center mb-6">
                            <div className="flex items-center gap-4">
                                <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2"><div className="w-1 h-5 bg-blue-500 rounded-full"></div> ä¸Šå¸‚å®£ä¼ èŠ‚å¥ (T-7 ~ T+35)</h3>
                                {canEdit && <button onClick={clearSchedule} className="text-xs flex items-center gap-1 text-slate-400 hover:text-red-500 bg-slate-50 hover:bg-red-50 px-2 py-1 rounded border border-slate-200 hover:border-red-200 transition-colors"><Trash2 size={12}/> æ¸…ç©ºé»˜è®¤æ’æœŸ</button>}
                            </div>
                            <div className="text-xs text-slate-400 flex gap-4"><span>å•å‡»: é€‰æ‹©ç‰©æ–™</span><span>åŒå‡»: è‡ªå®šä¹‰æ–‡å­—</span></div>
                        </div>
                        <div className="overflow-x-auto pb-4">
                            <div className="flex gap-2 min-w-max">
                                {timelineDates.map(dayObj => {
                                    const events = product.calendarEvents[dayObj.date] || [];
                                    const isLaunchDay = dayObj.type === 'launch';
                                    const marketingNode = getMarketingNode(dayObj.date, customNodes);
                                    const dayOfWeek = new Date(dayObj.date).getDay();
                                    const weekName = WEEK_NAMES[dayOfWeek];
                                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                                    
                                    // è·å–è¯¦ç»†çš„æ—¥æœŸä¿¡æ¯ (å«å†œå†)
                                    const dateInfo = getDateInfo(dayObj.date, customNodes);
                                    
                                    return (
                                        <div key={dayObj.date} className={`w-32 flex-shrink-0 border rounded-lg flex flex-col transition-all select-none ${canEdit ? 'cursor-pointer' : ''} ${isLaunchDay ? 'border-red-400 bg-red-50' : 'bg-white border-slate-200'} ${selectedDate === dayObj.date ? 'ring-2 ring-indigo-400' : ''}`} onClick={(e) => handleDayClick(e, dayObj.date)}>
                                            <div className={`p-2 text-center border-b text-xs font-bold uppercase relative ${isLaunchDay ? 'bg-red-100 text-red-700' : marketingNode ? 'bg-purple-100 text-purple-700' : isWeekend ? 'bg-slate-100 text-slate-400' : 'bg-slate-50 text-slate-600'}`}>
                                                <div className="flex justify-between px-1"><span>{getDayLabel(dayObj.dayOffset)}</span><span className="opacity-75">{weekName}</span></div>
                                                <div className="font-normal text-[10px] mt-0.5 opacity-80">{dayObj.date}</div>
                                                {/* å†œå†æ˜¾ç¤º - ä¼˜å…ˆæ˜¾ç¤ºèŠ‚æ—¥/èŠ‚æ°” */}
                                                <div className={`text-[9px] mt-1 ${dateInfo.isHighlight ? 'font-bold text-purple-600 lunar-text' : 'text-slate-400 lunar-text'}`}>
                                                    {dateInfo.label}
                                                </div>
                                            </div>
                                            <div className="p-2 min-h-[100px] space-y-1.5">{events.map((ev, i) => (<div key={i} className={`text-xs px-2 py-1 rounded border relative group ${ev.type === 'tag' ? 'bg-blue-50 text-blue-700 border-blue-100' : 'bg-amber-50 text-amber-800 border-amber-100 italic'}`}>{ev.content}{canEdit && <button onClick={(e) => removeEvent(e, dayObj.date, i)} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-3 h-3 flex items-center justify-center opacity-0 group-hover:opacity-100 text-[8px]">Ã—</button>}</div>))}{events.length === 0 && <div className="h-full flex items-center justify-center text-slate-300 text-[10px]">{canEdit ? "+ è§„åˆ’" : ""}</div>}</div>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    </section>
                    {modalType && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/20" onClick={closeModal}>
                            <div className="bg-white rounded-lg shadow-xl w-80 p-4 animate-in fade-in zoom-in duration-200" onClick={(e) => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 border-b pb-2"><h4 className="font-bold text-slate-700">{modalType === 'select' ? 'é€‰æ‹©ç‰©æ–™' : 'è‡ªå®šä¹‰å¤‡æ³¨'}</h4><div className="text-xs text-slate-400">{selectedDate}</div></div>
                                {modalType === 'select' ? (<div className="grid grid-cols-2 gap-2">{MATERIAL_OPTIONS.map(opt => (<button key={opt} onClick={() => addEvent(opt, 'tag')} className="text-sm px-3 py-2 bg-slate-50 hover:bg-indigo-50 text-slate-700 hover:text-indigo-700 rounded border border-slate-200 hover:border-indigo-200 transition">{opt}</button>))}</div>) : (<div><textarea className="w-full border border-slate-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-indigo-200 outline-none mb-3" rows={3} placeholder="è¾“å…¥è‡ªå®šä¹‰å†…å®¹..." value={editText} onChange={(e) => setEditText(e.target.value)} autoFocus></textarea><div className="flex justify-end gap-2"><button onClick={closeModal} className="px-3 py-1.5 text-xs text-slate-500 hover:bg-slate-100 rounded">å–æ¶ˆ</button><button onClick={() => addEvent(editText, 'text')} className="px-3 py-1.5 text-xs bg-indigo-600 text-white rounded hover:bg-indigo-700">ä¿å­˜</button></div></div>)}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const MasterCalendarPage = ({ products, navigateToProduct, customNodes, setCustomNodes, canEdit, updateProductDeep, customInputHistory, addCustomInputHistory }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [showNodeModal, setShowNodeModal] = useState(false);
            const [newNodeDate, setNewNodeDate] = useState('');
            const [newNodeName, setNewNodeName] = useState('');
            
            // Add schedule modal state
            const [showAddEventModal, setShowAddEventModal] = useState(false);
            const [eventDate, setEventDate] = useState('');
            const [targetProductId, setTargetProductId] = useState('');
            const [targetContent, setTargetContent] = useState('');
            const [isCustomContent, setIsCustomContent] = useState(false);

            const getDaysInMonth = (date) => { const year = date.getFullYear(); const month = date.getMonth(); const days = new Date(year, month + 1, 0).getDate(); const firstDay = new Date(year, month, 1).getDay(); return { days, firstDay }; };
            const { days, firstDay } = getDaysInMonth(currentDate);
            const monthNames = ["ä¸€æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"];
            const changeMonth = (offset) => { const newDate = new Date(currentDate); newDate.setMonth(newDate.getMonth() + offset); setCurrentDate(newDate); };
            
            const handleAddNode = () => {
                if (!newNodeDate || !newNodeName) return alert('è¯·å¡«å†™æ—¥æœŸå’Œåç§°');
                setCustomNodes({ ...customNodes, [newNodeDate]: newNodeName });
                setNewNodeDate(''); setNewNodeName(''); setShowNodeModal(false);
            };

            const handleDeleteNode = (dateKey) => {
                const newNodes = { ...customNodes };
                delete newNodes[dateKey];
                setCustomNodes(newNodes);
            };

            // Handle clicking on a calendar cell to add event
            const handleCellClick = (dateStr) => {
                if (!canEdit) return;
                setEventDate(dateStr);
                
                // Set default product if available
                const sortedProducts = [...products].sort((a, b) => {
                    if (a.level === b.level) return 0;
                    return a.level === 'é‡ç‚¹å“' ? -1 : 1;
                });
                
                if (sortedProducts.length > 0) {
                    setTargetProductId(sortedProducts[0].id);
                }
                
                setTargetContent(MATERIAL_OPTIONS[0]);
                setIsCustomContent(false);
                setShowAddEventModal(true);
            };

            const handleSaveEvent = () => {
                if (!targetProductId || !targetContent) return;
                
                // ğŸ”¥ å¦‚æœæ˜¯è‡ªå®šä¹‰å†…å®¹ï¼Œä¿å­˜åˆ°å†å²è®°å½• ğŸ”¥
                if (isCustomContent) {
                    addCustomInputHistory(targetContent);
                }

                // Find existing events for this product on this day to append
                const product = products.find(p => p.id == targetProductId);
                if (!product) return;
                
                const currentDayEvents = product.calendarEvents[eventDate] || [];
                // Check if content already exists to avoid duplicates
                if (!currentDayEvents.some(e => e.content === targetContent)) {
                    const newEvents = [...currentDayEvents, { type: 'tag', content: targetContent }];
                    updateProductDeep(product.id, ['calendarEvents', eventDate], newEvents);
                }
                
                setShowAddEventModal(false);
                setTargetContent(MATERIAL_OPTIONS[0]);
            };

            const renderCalendarCells = () => {
                const cells = [];
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                for (let i = 0; i < firstDay; i++) cells.push(<div key={`empty-${i}`} className="bg-slate-50 border-b border-r min-h-[120px]"></div>);
                for (let d = 1; d <= days; d++) {
                    const dateStr = formatDate(new Date(year, month, d));
                    const isToday = dateStr === formatDate(new Date());
                    
                    // è·å–æ—¥æœŸä¿¡æ¯ï¼ˆåŒ…æ‹¬å†œå†ï¼‰
                    const dateInfo = getDateInfo(dateStr, customNodes);
                    const isCustom = dateInfo.type === 'custom';

                    const dayEvents = products.map(p => {
                        const events = p.calendarEvents[dateStr] || [];
                        const isLaunch = p.launchDate === dateStr;
                        if (events.length === 0 && !isLaunch) return null;
                        return { product: p, events, isLaunch, color: getProductColor(p.id) };
                    }).filter(Boolean);
                    cells.push(
                        <div 
                            key={d} 
                            className={`border-b border-r p-2 min-h-[120px] relative group ${isToday ? 'bg-indigo-50/30' : 'bg-white hover:bg-slate-50 transition-colors'}`}
                            onClick={(e) => {
                                // Only trigger if clicking the cell background, not the items
                                if(e.target === e.currentTarget || e.target.classList.contains('cell-click-area')) {
                                    handleCellClick(dateStr);
                                }
                            }}
                        >
                            <div className="flex justify-between items-start mb-2 pointer-events-none">
                                <div className="flex flex-col">
                                    <span className={`text-sm font-bold ${isToday ? 'bg-indigo-600 text-white w-6 h-6 rounded-full flex items-center justify-center' : 'text-slate-700'}`}>{d}</span>
                                    {/* å†œå†æ˜¾ç¤º - ä¼˜å…ˆæ˜¾ç¤ºèŠ‚æ—¥/èŠ‚æ°” */}
                                    <span className={`text-[10px] mt-0.5 lunar-text ${dateInfo.isHighlight ? 'text-purple-600 font-bold' : 'text-slate-400'}`}>
                                        {dateInfo.label}
                                    </span>
                                </div>
                                {dateInfo.isHighlight && dateInfo.type !== 'lunar_normal' && (
                                    <div className={`text-[10px] px-1.5 py-0.5 rounded font-medium flex items-center gap-1 ${isCustom ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'} pointer-events-auto`}>
                                        {/* åªæ˜¾ç¤ºé‡è¦çš„æ ‡ç­¾åï¼Œå¦‚æœå’Œå†œå†é‡åå¯çœç•¥ï¼Œè¿™é‡Œç®€å•å¤„ç† */}
                                        {isCustom && canEdit && <button onClick={(e)=>{e.stopPropagation(); handleDeleteNode(dateStr)}} className="text-blue-400 hover:text-red-500 ml-1">Ã—</button>}
                                    </div>
                                )}
                            </div>
                            
                            <div className="space-y-1 overflow-y-auto max-h-[100px] scrollbar-hide pointer-events-auto">
                                {dayEvents.map((item, idx) => (
                                    <div key={idx} className="mb-2 last:mb-0">
                                        {item.isLaunch && (<div className="bg-red-500 text-white text-[10px] px-1.5 py-1 rounded font-bold mb-1 cursor-pointer truncate shadow-sm flex items-center gap-1" onClick={(e) => {e.stopPropagation(); navigateToProduct(item.product.id)}}>ğŸš€ [{item.product.name}] ä¸Šå¸‚</div>)}
                                        {item.events.map((ev, ei) => (<div key={ei} className={`text-[10px] px-1.5 py-1 rounded border mb-0.5 truncate cursor-pointer flex items-center gap-1 ${item.color.bg} ${item.color.text} ${item.color.border} border`} title={`${item.product.name}: ${ev.content}`} onClick={(e) => {e.stopPropagation(); navigateToProduct(item.product.id)}}><span className={`w-1.5 h-1.5 rounded-full flex-shrink-0 ${item.color.dot}`}></span><span className="font-bold opacity-90">[{item.product.name}]</span><span>{ev.content}</span></div>))}
                                    </div>
                                ))}
                            </div>
                            
                            {/* Hover Add Button Hint */}
                            {canEdit && <div className="absolute bottom-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                <span className="bg-indigo-100 text-indigo-600 p-1 rounded shadow-sm"><Plus size={12}/></span>
                            </div>}
                            
                            {/* Invisible click area to ensure easy clicking */}
                            <div className="absolute inset-0 z-0 cell-click-area"></div>
                        </div>
                    );
                }
                return cells;
            };

            const sortedProducts = [...products].sort((a, b) => {
                if (a.level === b.level) return 0;
                return a.level === 'é‡ç‚¹å“' ? -1 : 1;
            });

            return (
                <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden relative">
                    <div className="p-6 border-b flex justify-between items-center bg-slate-50">
                        <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><CalendarIcon className="text-indigo-600" /> æ•´ä½“å…¨æ¡ˆæ’æœŸ</h2>
                        <div className="flex items-center gap-4">
                            {canEdit && <button onClick={() => setShowNodeModal(true)} className="flex items-center gap-1 px-3 py-1.5 bg-white border border-indigo-200 text-indigo-600 rounded hover:bg-indigo-50 text-sm"><Plus size={14}/> ç®¡ç†è¥é”€èŠ‚ç‚¹</button>}
                            <div className="flex items-center bg-white rounded-md border shadow-sm"><button onClick={() => changeMonth(-1)} className="p-2 hover:bg-slate-100"><ChevronLeft size={20}/></button><div className="w-32 text-center font-bold text-slate-700">{currentDate.getFullYear()}å¹´ {monthNames[currentDate.getMonth()]}</div><button onClick={() => changeMonth(1)} className="p-2 hover:bg-slate-100"><ChevronRight size={20}/></button></div>
                        </div>
                    </div>
                    <div className="grid grid-cols-7 bg-slate-100 border-b">{['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'].map(d => (<div key={d} className="p-3 text-center text-sm font-medium text-slate-500">{d}</div>))}</div>
                    <div className="grid grid-cols-7">{renderCalendarCells()}</div>

                    {showNodeModal && (
                        <div className="absolute inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowNodeModal(false)}>
                            <div className="bg-white p-6 rounded-xl shadow-xl w-80" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-bold mb-4">æ·»åŠ è‡ªå®šä¹‰è¥é”€èŠ‚ç‚¹</h3>
                                <div className="space-y-4">
                                    <div><label className="block text-xs text-slate-500 mb-1">æ—¥æœŸ</label><input type="date" className="w-full border rounded p-2 text-sm" value={newNodeDate} onChange={e => setNewNodeDate(e.target.value)} /></div>
                                    <div><label className="block text-xs text-slate-500 mb-1">èŠ‚ç‚¹åç§°</label><input type="text" className="w-full border rounded p-2 text-sm" placeholder="ä¾‹å¦‚ï¼šå…¬å¸å‘¨å¹´åº†" value={newNodeName} onChange={e => setNewNodeName(e.target.value)} /></div>
                                    <button onClick={handleAddNode} className="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">æ·»åŠ </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* å¿«æ·æ·»åŠ æ’æœŸ Modal */}
                    {showAddEventModal && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/20 backdrop-blur-sm" onClick={() => setShowAddEventModal(false)}>
                            <div className="bg-white rounded-xl shadow-2xl w-80 p-5 animate-in fade-in zoom-in duration-200" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4 pb-2 border-b">
                                    <h4 className="font-bold text-slate-800">å¿«æ·æ·»åŠ æ’æœŸ</h4>
                                    <div className="text-xs text-slate-500">{eventDate}</div>
                                </div>
                                
                                <div className="space-y-4">
                                    {/* 1. é€‰æ‹©äº§å“ */}
                                    <div>
                                        <label className="block text-xs font-bold text-slate-600 mb-1">é€‰æ‹©äº§å“</label>
                                        <select 
                                            className="w-full border rounded p-2 text-sm bg-slate-50 outline-none focus:ring-2 focus:ring-indigo-200"
                                            value={targetProductId}
                                            onChange={(e) => setTargetProductId(e.target.value)}
                                        >
                                            {sortedProducts.map(p => (
                                                <option key={p.id} value={p.id}>
                                                    {p.level === 'é‡ç‚¹å“' ? 'â˜… ' : ''}{p.name}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    {/* 2. é€‰æ‹©å†…å®¹ */}
                                    <div>
                                        <div className="flex justify-between items-center mb-1">
                                            <label className="block text-xs font-bold text-slate-600">æ’æœŸå†…å®¹</label>
                                            <button 
                                                className="text-[10px] text-indigo-600 hover:underline"
                                                onClick={() => setIsCustomContent(!isCustomContent)}
                                            >
                                                {isCustomContent ? "åˆ‡æ¢å›åˆ—è¡¨" : "è‡ªå®šä¹‰è¾“å…¥"}
                                            </button>
                                        </div>
                                        
                                        {isCustomContent ? (
                                            <div>
                                                <input 
                                                    type="text" 
                                                    className="w-full border rounded p-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                                                    placeholder="è¾“å…¥è‡ªå®šä¹‰å†…å®¹..."
                                                    value={targetContent}
                                                    onChange={(e) => setTargetContent(e.target.value)}
                                                    autoFocus
                                                />
                                                {/* ğŸ”¥ æ˜¾ç¤ºå†å²è®°å½• ğŸ”¥ */}
                                                {customInputHistory && customInputHistory.length > 0 && (
                                                    <div className="mt-2">
                                                        <div className="text-[10px] text-slate-400 mb-1">æœ€è¿‘ä½¿ç”¨:</div>
                                                        <div className="flex flex-wrap gap-1">
                                                            {customInputHistory.map((item, idx) => (
                                                                <button 
                                                                    key={idx}
                                                                    onClick={() => setTargetContent(item)}
                                                                    className="text-[10px] bg-slate-100 hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 px-2 py-1 rounded border border-transparent hover:border-indigo-100 transition-colors"
                                                                >
                                                                    {item}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ) : (
                                            <select 
                                                className="w-full border rounded p-2 text-sm bg-slate-50 outline-none focus:ring-2 focus:ring-indigo-200"
                                                value={targetContent}
                                                onChange={(e) => setTargetContent(e.target.value)}
                                            >
                                                {MATERIAL_OPTIONS.map(opt => (
                                                    <option key={opt} value={opt}>{opt}</option>
                                                ))}
                                            </select>
                                        )}
                                    </div>

                                    <div className="flex gap-2 pt-2">
                                        <button 
                                            onClick={() => setShowAddEventModal(false)}
                                            className="flex-1 py-2 text-xs text-slate-500 hover:bg-slate-100 rounded"
                                        >
                                            å–æ¶ˆ
                                        </button>
                                        <button 
                                            onClick={handleSaveEvent}
                                            className="flex-1 py-2 text-xs bg-indigo-600 text-white rounded hover:bg-indigo-700 font-medium"
                                        >
                                            ç¡®è®¤æ·»åŠ 
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- 5. ä¸»ç»„ä»¶ (App, å¿…é¡»æœ€åå®šä¹‰) ---

        const App = () => {
            const [appData, setAppData] = useState({ products: [], customNodes: {}, settings: { visitors: [], logs: [], customInputHistory: [] } });
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [syncStatus, setSyncStatus] = useState('syncing'); 
            const [view, setView] = useState('home'); 
            const [activeProductId, setActiveProductId] = useState(null);
            const [showRecycleBin, setShowRecycleBin] = useState(false);
            
            const [role, setRole] = useState('guest'); 
            const [currentUser, setCurrentUser] = useState(null); 
            const [showLoginModal, setShowLoginModal] = useState(false);
            const [showAdminPanel, setShowAdminPanel] = useState(false);
            const [inputPwd, setInputPwd] = useState('');
            const [adminTab, setAdminTab] = useState('visitors'); 
            const [newVisitorName, setNewVisitorName] = useState('');
            const [newVisitorPwd, setNewVisitorPwd] = useState('');

            const timeoutRef = useRef(null);

            useEffect(() => {
                if (window.dbConfigured === false) { setError('CONFIG_MISSING'); setLoading(false); return; }
                if (window.dbError) { setError('INIT_FAILED'); setLoading(false); return; }
                initRealtimeSync();
            }, []);

            const initRealtimeSync = async () => {
                if (!supabaseClient) return;
                try {
                    const { data, error } = await supabaseClient.from('projects').select('content').eq('id', 'main').single();
                    if (error && error.code !== 'PGRST116') throw error;

                    if (data && data.content) {
                        let content = data.content;
                        if (Array.isArray(content)) content = { products: content, customNodes: {}, settings: { visitors: [], logs: [] } };
                        if (!content.settings) content.settings = { visitors: [], logs: [] };
                        if (!content.settings.customInputHistory) content.settings.customInputHistory = [];
                        
                        // å…¼å®¹æ€§è¿ç§»: detailPage ä» ogc ç§»åˆ° basics
                        if (content.products) {
                            content.products = content.products.map(p => {
                                if (p.ogc && p.ogc.detailPage) {
                                    if (!p.basics) p.basics = {};
                                    // å¦‚æœ ogc é‡Œçš„ detailPage å®Œæˆäº†ï¼Œå°±åŒæ­¥ç»™ basics
                                    if (p.ogc.detailPage.done) p.basics.detailPage = true;
                                    // å¯é€‰ï¼šä» ogc ä¸­åˆ é™¤ detailPage (è¿™é‡Œæš‚ä¸åˆ ï¼Œåªåšæ•°æ®åŒæ­¥ï¼Œæ¸²æŸ“æ—¶è¿‡æ»¤)
                                }
                                return p;
                            });
                        }
                        
                        if (content.settings.userPassword) {
                            if (!content.settings.visitors) content.settings.visitors = [];
                            if (content.settings.visitors.length === 0) {
                                content.settings.visitors.push({ id: Date.now(), name: "é»˜è®¤è®¿å®¢", password: content.settings.userPassword });
                            }
                            delete content.settings.userPassword;
                        }
                        if (!content.settings.logs) content.settings.logs = [];
                        if (!content.settings.visitors) content.settings.visitors = [];

                        setAppData(content);
                    } else {
                        setAppData({ products: [], customNodes: {}, settings: { visitors: [], logs: [], customInputHistory: [] } });
                    }
                    setLoading(false); setSyncStatus('saved');

                    const channel = supabaseClient
                        .channel('public:projects')
                        .on('postgres_changes', { event: '*', schema: 'public', table: 'projects', filter: 'id=eq.main' }, (payload) => {
                            if (payload.new && payload.new.content) {
                                let content = payload.new.content;
                                if (Array.isArray(content)) content = { products: content, customNodes: {}, settings: { visitors: [], logs: [] } };
                                if (!content.settings.customInputHistory) content.settings.customInputHistory = [];
                                setAppData(content);
                            }
                        })
                        .subscribe();
                    return () => { supabaseClient.removeChannel(channel); };
                } catch (err) {
                    console.error("Sync error:", err);
                    setError('NETWORK_ERROR'); setLoading(false); setSyncStatus('error');
                }
            };

            const saveToCloud = (newData) => {
                if (!supabaseClient) return;
                setSyncStatus('syncing');
                if (timeoutRef.current) clearTimeout(timeoutRef.current);
                timeoutRef.current = setTimeout(async () => {
                    try {
                        const { error } = await supabaseClient.from('projects').upsert({ id: 'main', content: newData });
                        if (error) throw error;
                        setSyncStatus('saved');
                    } catch (e) { console.error("Save error:", e); setSyncStatus('error'); }
                }, 1000); 
            };

            const handleSetAppData = (newDataOrFn, logActionType = null, logDetail = null) => {
                setAppData(prev => {
                    let newData = typeof newDataOrFn === 'function' ? newDataOrFn(prev) : newDataOrFn;
                    if (logActionType && currentUser) {
                        const newLog = {
                            id: Date.now(),
                            timestamp: new Date().toISOString(),
                            user: currentUser,
                            role: role,
                            action: logActionType,
                            detail: logDetail || ''
                        };
                        const updatedLogs = [newLog, ...(newData.settings.logs || [])].slice(0, 200);
                        newData = { ...newData, settings: { ...newData.settings, logs: updatedLogs } };
                    }
                    saveToCloud(newData);
                    return newData;
                });
            };

            const setProducts = (newProductsOrFn, actionType, actionDetail) => {
                handleSetAppData(prev => {
                    const newProducts = typeof newProductsOrFn === 'function' ? newProductsOrFn(prev.products) : newProductsOrFn;
                    return { ...prev, products: newProducts };
                }, actionType, actionDetail);
            };

            const setCustomNodes = (newNodesOrFn) => {
                handleSetAppData(prev => {
                    const newNodes = typeof newNodesOrFn === 'function' ? newNodesOrFn(prev.customNodes) : newNodesOrFn;
                    return { ...prev, customNodes: newNodes };
                }, 'ä¿®æ”¹è¥é”€èŠ‚ç‚¹', 'æ›´æ–°äº†å…¨å±€æ—¥å†èŠ‚ç‚¹');
            };

            const addCustomInputHistory = (input) => {
                handleSetAppData(prev => {
                    const currentHistory = prev.settings.customInputHistory || [];
                    const newHistory = [input, ...currentHistory.filter(i => i !== input)].slice(0, 10);
                    return { ...prev, settings: { ...prev.settings, customInputHistory: newHistory } };
                });
            };

            const handleLogin = () => {
                if (inputPwd === ADMIN_PASSWORD) {
                    setRole('admin');
                    setCurrentUser('ç®¡ç†å‘˜');
                    setShowLoginModal(false);
                    setInputPwd('');
                    alert("ç®¡ç†å‘˜ç™»å½•æˆåŠŸï¼");
                } else {
                    const visitors = appData.settings.visitors || [];
                    const matchedVisitor = visitors.find(v => v.password === inputPwd);
                    if (matchedVisitor) {
                        setRole('user');
                        setCurrentUser(matchedVisitor.name);
                        setShowLoginModal(false);
                        setInputPwd('');
                        handleSetAppData(d => d, 'è®¿å®¢ç™»å½•', `è®¿å®¢ [${matchedVisitor.name}] è®¿é—®äº†ç³»ç»Ÿ`);
                        alert(`æ¬¢è¿ï¼Œ${matchedVisitor.name}ï¼ç¼–è¾‘æƒé™å·²è§£é”ã€‚`);
                    } else {
                        alert("å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚");
                    }
                }
            };

            const handleAddVisitor = () => {
                if (!newVisitorName || !newVisitorPwd) return alert("è¯·å¡«å†™åç§°å’Œå¯†ç ");
                handleSetAppData(prev => ({
                    ...prev,
                    settings: {
                        ...prev.settings,
                        visitors: [...(prev.settings.visitors || []), { id: Date.now(), name: newVisitorName, password: newVisitorPwd }]
                    }
                }));
                setNewVisitorName(''); setNewVisitorPwd('');
            };

            const handleDeleteVisitor = (id) => {
                if(!confirm("ç¡®å®šåˆ é™¤è¯¥è®¿å®¢å—ï¼Ÿ")) return;
                handleSetAppData(prev => ({
                    ...prev,
                    settings: {
                        ...prev.settings,
                        visitors: prev.settings.visitors.filter(v => v.id !== id)
                    }
                }));
            };

            const updateProduct = (id, field, value) => {
                const productName = appData.products.find(p => p.id === id)?.name || 'æœªçŸ¥äº§å“';
                setProducts(prev => {
                    let updated = prev.map(p => {
                        if (p.id !== id) return p;
                        if (field === 'launchDate' && value !== p.launchDate) {
                            const confirmRegen = window.confirm("æ£€æµ‹åˆ°ä¸Šå¸‚æ—¶é—´å·²ä¿®æ”¹ã€‚\n\næ˜¯å¦é‡æ–°ç”Ÿæˆé»˜è®¤è§„åˆ’ï¼Ÿ");
                            if (confirmRegen) return { ...p, [field]: value, calendarEvents: generateDefaultEvents(value, appData.customNodes) };
                        }
                        return { ...p, [field]: value };
                    });
                    if (field === 'level') {
                        const targetIndex = updated.findIndex(p => p.id === id);
                        if (targetIndex > -1) {
                            const item = updated[targetIndex];
                            if (value === 'é‡ç‚¹å“') { updated.splice(targetIndex, 1); updated.unshift(item); }
                        }
                    }
                    return updated;
                }, 'ä¿®æ”¹äº§å“ä¿¡æ¯', `ä¿®æ”¹äº† [${productName}] çš„ ${field}`);
            };

            const updateProductDeep = (id, pathArray, value) => {
                const productName = appData.products.find(p => p.id === id)?.name || 'æœªçŸ¥äº§å“';
                setProducts(prev => prev.map(p => {
                    if (p.id !== id) return p;
                    const newP = { ...p };
                    let current = newP;
                    for (let i = 0; i < pathArray.length - 1; i++) { current[pathArray[i]] = { ...current[pathArray[i]] }; current = current[pathArray[i]]; }
                    current[pathArray[pathArray.length - 1]] = value;
                    return newP;
                }), 'æ›´æ–°è¯¦ç»†è§„åˆ’', `æ›´æ–°äº† [${productName}] çš„æ’æœŸæˆ–ç‰©æ–™çŠ¶æ€`);
            };

            const softDeleteProduct = (id) => { 
                if(window.confirm('ç¡®å®šè¦ç§»é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿå®ƒå°†è¢«ç§»å…¥å›æ”¶ç«™ã€‚')) updateProduct(id, 'deleted', true);
            };
            const restoreProduct = (id) => updateProduct(id, 'deleted', false);
            const hardDeleteProduct = (id) => { 
                if(window.confirm('è­¦å‘Šï¼šæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) setProducts(prev => prev.filter(p => p.id !== id), 'æ°¸ä¹…åˆ é™¤', `å½»åº•åˆ é™¤äº†äº§å“ID: ${id}`); 
            };
            const navigateToProduct = (id) => { setActiveProductId(id); setView('product-detail'); };

            const activeProduct = appData.products.find(p => p.id === activeProductId);
            const activeProductsList = appData.products.filter(p => !p.deleted);
            const deletedProductsList = appData.products.filter(p => p.deleted);

            if (loading) return <div className="h-screen flex flex-col items-center justify-center space-y-4"><div className="loader"></div><p className="text-slate-500 text-sm">æ­£åœ¨åŠ è½½æ•°æ®...</p></div>;
            if (error === 'NETWORK_ERROR') return <div className="h-screen flex flex-col items-center justify-center text-red-500"><AlertTriangle size={48} className="mb-4"/><p>è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ã€‚</p><button onClick={()=>window.location.reload()} className="mt-4 px-4 py-2 bg-slate-100 rounded text-slate-700 text-sm">é‡è¯•</button></div>;

            const canEdit = role !== 'guest';
            const isAdmin = role === 'admin';

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans pb-10">
                    <header className="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-40 shadow-sm flex justify-between items-center">
                        <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('home')}>
                            <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center">
                                <LayoutGrid className="text-white w-5 h-5" />
                            </div>
                            <h1 className="text-xl font-bold text-slate-800">äº§å“ä¸Šå¸‚å…¨æ¡ˆé¡¹ç›®ç®¡ç† <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded ml-2 border border-green-200">Supabase</span></h1>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="flex items-center gap-2 text-xs mr-4">
                                {syncStatus === 'syncing' && <span className="text-amber-600 flex items-center gap-1"><span className="loader" style={{width:12, height:12, borderWidth:2}}></span> åŒæ­¥ä¸­...</span>}
                                {syncStatus === 'saved' && <span className="text-green-600 flex items-center gap-1"><Cloud size={14}/> å·²åŒæ­¥</span>}
                                {syncStatus === 'error' && <span className="text-red-600 flex items-center gap-1"><CloudOff size={14}/> åŒæ­¥å¤±è´¥</span>}
                            </div>
                            
                            {role === 'guest' ? (
                                <button onClick={() => setShowLoginModal(true)} className="flex items-center gap-2 px-3 py-2 bg-slate-100 text-slate-600 rounded-md hover:bg-slate-200 text-sm font-bold border border-slate-300">
                                    <Lock size={14} /> è§£é”ç¼–è¾‘
                                </button>
                            ) : (
                                <div className="flex items-center gap-2">
                                    {isAdmin && (
                                        <button onClick={() => setShowAdminPanel(true)} className="flex items-center gap-1 px-3 py-2 text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-md text-sm transition-colors font-medium">
                                            <Users size={14} /> ç”¨æˆ·ä¸æ—¥å¿—
                                        </button>
                                    )}
                                    <div className="flex items-center gap-1 px-3 py-2 bg-green-50 text-green-700 rounded-md text-sm border border-green-200">
                                        <Unlock size={14} /> {currentUser}
                                    </div>
                                </div>
                            )}

                            <div className="h-6 w-px bg-slate-200 mx-2"></div>

                            {view === 'home' && (
                                <>
                                    <button onClick={() => setView('master')} className="flex items-center gap-2 px-4 py-2 bg-indigo-50 text-indigo-700 rounded-md hover:bg-indigo-100 transition-colors font-medium text-sm"><CalendarIcon className="w-4 h-4" /> æ•´ä½“æ’æœŸ</button>
                                    {canEdit && (
                                        <button onClick={() => setShowRecycleBin(true)} className="flex items-center gap-2 px-3 py-2 text-slate-500 hover:text-slate-700 hover:bg-slate-100 rounded-md transition-colors text-sm relative">
                                            <Trash2 className="w-4 h-4" /> å›æ”¶ç«™
                                            {deletedProductsList.length > 0 && <span className="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>}
                                        </button>
                                    )}
                                </>
                            )}
                            {view !== 'home' && <button onClick={() => setView('home')} className="flex items-center gap-2 text-slate-500 hover:text-slate-800"><ArrowLeft className="w-4 h-4" /> è¿”å›é¦–é¡µ</button>}
                        </div>
                    </header>

                    <main className="p-6 max-w-7xl mx-auto">
                        {view === 'home' && (
                            <HomePage 
                                products={activeProductsList} 
                                setProducts={setProducts} 
                                fullProductList={appData.products} 
                                navigateToProduct={navigateToProduct} 
                                updateProduct={updateProduct}
                                updateProductDeep={updateProductDeep} 
                                softDeleteProduct={softDeleteProduct}
                                customNodes={appData.customNodes}
                                canEdit={canEdit}
                                currentUser={currentUser}
                            />
                        )}
                        {view === 'product-detail' && activeProduct && (
                            <ProductDetailPage 
                                product={activeProduct} 
                                updateProduct={updateProduct}
                                updateProductDeep={updateProductDeep}
                                customNodes={appData.customNodes}
                                canEdit={canEdit}
                            />
                        )}
                        {view === 'master' && (
                            <MasterCalendarPage 
                                products={activeProductsList} 
                                navigateToProduct={navigateToProduct} 
                                customNodes={appData.customNodes}
                                setCustomNodes={setCustomNodes}
                                canEdit={canEdit}
                                updateProductDeep={updateProductDeep}
                                customInputHistory={appData.settings.customInputHistory || []}
                                addCustomInputHistory={addCustomInputHistory}
                            />
                        )}
                    </main>

                    {/* ç™»å½•å¼¹çª— */}
                    {showLoginModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm" onClick={() => setShowLoginModal(false)}>
                            <div className="bg-white p-6 rounded-xl shadow-2xl w-80" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Lock size={18}/> æƒé™éªŒè¯</h3>
                                <p className="text-xs text-slate-500 mb-4">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç æˆ–è®¿å®¢å¯†ç ä»¥è§£é”ç¼–è¾‘ã€‚</p>
                                <input type="password" autoFocus className="w-full border p-2 rounded mb-4" placeholder="åœ¨æ­¤è¾“å…¥å¯†ç ..." value={inputPwd} onChange={e => setInputPwd(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleLogin()} />
                                <button onClick={handleLogin} className="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">è§£é”</button>
                            </div>
                        </div>
                    )}

                    {/* ç®¡ç†å‘˜é¢æ¿ */}
                    {showAdminPanel && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm" onClick={() => setShowAdminPanel(false)}>
                            <div className="bg-white rounded-xl shadow-2xl w-[700px] h-[500px] flex flex-col overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b bg-slate-50 flex justify-between items-center">
                                    <div className="flex gap-4">
                                        <button onClick={() => setAdminTab('visitors')} className={`pb-2 text-sm font-bold border-b-2 ${adminTab === 'visitors' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-slate-500'}`}>è®¿å®¢ç®¡ç†</button>
                                        <button onClick={() => setAdminTab('logs')} className={`pb-2 text-sm font-bold border-b-2 ${adminTab === 'logs' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-slate-500'}`}>æ“ä½œæ—¥å¿—</button>
                                    </div>
                                    <button onClick={() => setShowAdminPanel(false)} className="text-slate-400 hover:text-slate-600"><X size={18}/></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-6">
                                    {adminTab === 'visitors' ? (
                                        <div className="space-y-6">
                                            <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                                                <h4 className="text-sm font-bold text-indigo-800 mb-2">æ·»åŠ æ–°è®¿å®¢</h4>
                                                <div className="flex gap-3">
                                                    <input className="flex-1 border rounded px-2 py-1 text-sm" placeholder="è®¿å®¢åç§° (å¦‚: Agency A)" value={newVisitorName} onChange={e => setNewVisitorName(e.target.value)} />
                                                    <input className="flex-1 border rounded px-2 py-1 text-sm" placeholder="è®¾ç½®å¯†ç " value={newVisitorPwd} onChange={e => setNewVisitorPwd(e.target.value)} />
                                                    <button onClick={handleAddVisitor} className="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700">æ·»åŠ </button>
                                                </div>
                                            </div>
                                            <div>
                                                <h4 className="text-sm font-bold text-slate-700 mb-3">ç°æœ‰è®¿å®¢åˆ—è¡¨</h4>
                                                <div className="space-y-2">
                                                    {(appData.settings.visitors || []).length === 0 && <div className="text-slate-400 text-sm text-center py-4">æš‚æ— è®¿å®¢ï¼Œè¯·æ·»åŠ </div>}
                                                    {(appData.settings.visitors || []).map(v => (
                                                        <div key={v.id} className="flex justify-between items-center p-3 bg-white border rounded shadow-sm">
                                                            <div className="flex gap-4">
                                                                <span className="font-bold text-slate-700 w-32 truncate">{v.name}</span>
                                                                <span className="font-mono text-slate-500 bg-slate-100 px-2 rounded text-xs py-0.5">PWD: {v.password}</span>
                                                            </div>
                                                            <button onClick={() => handleDeleteVisitor(v.id)} className="text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded"><Trash2 size={14}/></button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            {(appData.settings.logs || []).length === 0 && <div className="text-center py-10 text-slate-400">æš‚æ— æ—¥å¿—è®°å½•</div>}
                                            {(appData.settings.logs || []).map(log => (
                                                <div key={log.id} className="text-sm border-b pb-2 last:border-0">
                                                    <div className="flex justify-between mb-1">
                                                        <span className="font-bold text-slate-700">{log.user} <span className="text-xs font-normal text-slate-400 ml-1">({new Date(log.timestamp).toLocaleString()})</span></span>
                                                        <span className={`text-xs px-2 py-0.5 rounded ${log.action === 'è®¿å®¢ç™»å½•' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{log.action}</span>
                                                    </div>
                                                    <div className="text-slate-500 pl-2 border-l-2 border-slate-200">{log.detail}</div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {showRecycleBin && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" onClick={() => setShowRecycleBin(false)}>
                            <div className="bg-white rounded-xl shadow-2xl w-[600px] max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                                <div className="p-6 border-b flex justify-between items-center"><h3 className="text-xl font-bold flex items-center gap-2 text-slate-800"><Trash2 className="text-slate-400" /> å›æ”¶ç«™</h3><button onClick={() => setShowRecycleBin(false)} className="text-slate-400 hover:text-slate-600"><X /></button></div>
                                <div className="p-6 overflow-y-auto flex-1">
                                    {deletedProductsList.length === 0 ? <div className="text-center py-10 text-slate-400"><Trash2 className="w-12 h-12 mx-auto mb-3 opacity-20" /><p>å›æ”¶ç«™æ˜¯ç©ºçš„</p></div> : (
                                        <div className="space-y-3">
                                            {deletedProductsList.map(p => (
                                                <div key={p.id} className="flex items-center justify-between p-4 bg-slate-50 rounded-lg border border-slate-100">
                                                    <div><div className="font-bold text-slate-700">{p.name}</div><div className="text-xs text-slate-400 mt-1">åŸå®šä¸Šå¸‚: {p.launchDate}</div></div>
                                                    <div className="flex gap-2"><button onClick={() => restoreProduct(p.id)} className="flex items-center gap-1 px-3 py-1.5 bg-green-50 text-green-700 hover:bg-green-100 rounded text-sm transition-colors"><RefreshCcw size={14} /> æ¢å¤</button><button onClick={() => hardDeleteProduct(p.id)} className="flex items-center gap-1 px-3 py-1.5 bg-red-50 text-red-700 hover:bg-red-100 rounded text-sm transition-colors"><X size={14} /> å½»åº•åˆ é™¤</button></div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
